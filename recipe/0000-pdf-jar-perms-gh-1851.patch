From 9111849a72133eb8f0d935df59430964762647d2 Mon Sep 17 00:00:00 2001
From: Matthew Berryman <matthew@acrossthecloud.net>
Date: Mon, 8 Jul 2024 15:18:07 +0930
Subject: [PATCH 1/2] fix PDF support

---
 build.gradle.kts | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/build.gradle.kts b/build.gradle.kts
index eeb6b69d86a..a3dbeb7012c 100644
--- a/build.gradle.kts
+++ b/build.gradle.kts
@@ -43,7 +43,8 @@ dependencies {
 		testImplementation("org.mockito:mockito-junit-jupiter:5.+")
 	}
 	implementation("org.scilab.forge:jlatexmath:1.0.7")
-	
+	"pdfRuntimeOnly"("org.apache.xmlgraphics:fop:2.9")
+	"pdfRuntimeOnly"("org.apache.xmlgraphics:batik-all:1.17")
     implementation("org.eclipse.elk:org.eclipse.elk.core:0.9.1")
     implementation("org.eclipse.elk:org.eclipse.elk.alg.layered:0.9.1")
     implementation("org.eclipse.elk:org.eclipse.elk.alg.mrtree:0.9.1")
@@ -183,7 +184,9 @@ val pdfJar by tasks.registering(Jar::class) {
 	manifest.attributes["Main-Class"] = "net.sourceforge.plantuml.Run"
 	duplicatesStrategy = DuplicatesStrategy.EXCLUDE
 	val dependencies = configurations.runtimeClasspath.get().map(::zipTree)
-	from(dependencies)
+	from(dependencies) {
+        exclude("META-INF/*.SF", "META-INF/*.DSA", "META-INF/*.RSA") // Avoid conflict on signature
+    }
 	with(tasks.jar.get())
 	archiveAppendix.set("pdf")
 }

From 1ca37a1ab7ebcf0b782e842b017203af6611fb67 Mon Sep 17 00:00:00 2001
From: Matthew Berryman <matthew@acrossthecloud.net>
Date: Mon, 8 Jul 2024 17:39:19 +0930
Subject: [PATCH 2/2] feature: avoid FOP in regular JAR build

---
 build.gradle.kts | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/build.gradle.kts b/build.gradle.kts
index a3dbeb7012c..0f5c6010003 100644
--- a/build.gradle.kts
+++ b/build.gradle.kts
@@ -43,11 +43,14 @@ dependencies {
 		testImplementation("org.mockito:mockito-junit-jupiter:5.+")
 	}
 	implementation("org.scilab.forge:jlatexmath:1.0.7")
-	"pdfRuntimeOnly"("org.apache.xmlgraphics:fop:2.9")
-	"pdfRuntimeOnly"("org.apache.xmlgraphics:batik-all:1.17")
     implementation("org.eclipse.elk:org.eclipse.elk.core:0.9.1")
     implementation("org.eclipse.elk:org.eclipse.elk.alg.layered:0.9.1")
     implementation("org.eclipse.elk:org.eclipse.elk.alg.mrtree:0.9.1")
+
+    // Custom configuration for pdfJar task
+    configurations.create("pdfJarDeps")
+    "pdfJarDeps"("org.apache.xmlgraphics:fop:2.9")
+    "pdfJarDeps"("org.apache.xmlgraphics:batik-all:1.17")
     
 }
 
@@ -183,7 +186,7 @@ val pdfJar by tasks.registering(Jar::class) {
 	description = "Assembles a jar containing dependencies to create PDFs."
 	manifest.attributes["Main-Class"] = "net.sourceforge.plantuml.Run"
 	duplicatesStrategy = DuplicatesStrategy.EXCLUDE
-	val dependencies = configurations.runtimeClasspath.get().map(::zipTree)
+  val dependencies = configurations["pdfJarDeps"].map(::zipTree) + configurations.runtimeClasspath.get().map(::zipTree)
 	from(dependencies) {
         exclude("META-INF/*.SF", "META-INF/*.DSA", "META-INF/*.RSA") // Avoid conflict on signature
     }
